<html>
	<head>
		<title>$$$GRAPH_TITLE$$$</title>

		<meta charset="UTF-8"> 
		<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1, maximum-scale=1"/>

		<script src="js/cytoscape-3.21.1.min.js"></script>
        <script src="js/layout-base.js"></script>
		<script src="js/cose-base.js"></script>
		<script src="js/cytoscape-fcose.js"></script>
		<script src="js/jquery-3.0.0.min.js"></script>
		<script src="js/cytoscape-graphml-1.0.6-hier.js"></script>
		<script src="js/cytoscape-expand-collapse.js"></script>	

		<style>
			body {
				font-family: helvetica neue, helvetica, liberation sans, arial, sans-serif;
				font-size: 14px;
				background-color: white;
			}
			
			html, body, #full {
			  	height: 100%;
			}
			#full {
			  	display: flex;
			  	flex-direction: column;
			}
			#cy {
				flex-grow: 1;
				z-index: 10;
			}
			#header { 
				position: fixed; 
				z-index: 11; 
				background-color: #e2e2e2; 
				overflow-x: hidden;
				padding: 20px 15px;
			}
			#header b {
				padding: 6px 0;
				color: #333333;
				display: block;
				cursor: pointer; 
			}
			#header span {
				padding: 6px 0;
				display: block;
			}
			#header span label b {
				padding: 0;
				display: inline; 
			}
			#header span input {
				margin: 0;
			}
		</style>
	</head>

	<body>
		<h1>$$$GRAPH_TITLE$$$</h1>
		<h3>$$$GRAPH_DESCRIPTION$$$</h3>
		<hr/>
		<div id="full">
			<div id="header">
				<b id="defaultView">Reset collapsed nodes</b>
				<b id="relayout">Run layout</b> 
				<hr/>
				<b id="collapseAll">Collapse all</b> 
				<b id="expandAll">Expand all</b> 
				<b id="collapseSubNodes">Collapse sub nodes</b> 
				<b id="expandSubNodes">Expand sub nodes</b> 
				<b id="collapseDescriptions">Collapse $$$GRAPH_DESCRIPTION_LABEL$$$</b> 
				<b id="expandDescriptions">Expand $$$GRAPH_DESCRIPTION_LABEL$$$</b> 
				<hr/>
				$$$GRAPH_DISPLAY_SWITCHES$$$
			</div>
			<div id="cy"></div>
		</div>
		<script>			
		var api;
		var layoutOptions;
		var cy = window.cy = cytoscape({
			container: document.getElementById('cy'),
			minZoom: 0.3,
			maxZoom: 100,
			zoomingEnabled: true,
			userZoomingEnabled: true,
			style: [
				{
					selector: 'node',
					css: {
						'background-color': 'white',
						'color': 'black',
						'font-size': '12px',
						'font-weight': 'bold',
						'shape': 'rectangle',
						'border-width': '1px',
						'border-style': 'solid',
						'border-color': 'darkgray',
					}
				},
				{
					selector: 'node[NODE_TEXT]',
					css: {
						'content': 'data(NODE_TEXT)'
					}
				},
				{
					selector: 'node[LABEL_TEXT]',
					css: {
						'content': 'data(LABEL_TEXT)',
						'width': 'label',
						'text-valign': 'center',
						'border-width': '0px',
					}
				},
				{
					selector: 'node[NODE_KIND = "SUBNODE"]',
					css: {
						'content': '',
						'border-width': '0px',
					}
				},
				{
					selector: 'node[NODE_KIND = "SUBNODE"].cy-expand-collapse-collapsed-node',
					css: {
						'content': '',
						'border-width': '1px',
						'border-style': 'solid',
						'border-color': 'darkgray',
					}
				},
				{
					selector: 'node[NODE_KIND = "DESCRIPTION"]',
					css: {
						'content': '',
						'border-width': '0px',
					}
				},	
				{
					selector: 'node[NODE_KIND = "DESCRIPTION"].cy-expand-collapse-collapsed-node',
					css: {
						'content': '$$$GRAPH_DESCRIPTION_LABEL$$$',
						'border-width': '1px',
						'border-style': 'solid',
						'border-color': 'darkgray',
					}
				},	
				{
					selector: 'node[NODE_IS_ENTRY = "yes"]',
					css: {
						'border': '1px solid black',
					}
				},		
				{
					selector: 'node[NODE_IS_ENTRY = "yes"]',
					css: {
						'border-width': '5px',
						'border-style': 'solid',
						'border-color': 'black',
					}
				},	
				{
					selector: 'node[NODE_IS_EXIT = "yes"]',
					css: {
						'border-width': '5px',
						'border-style': 'double',
						'border-color': 'black',
					}
				},	
				{
					selector: 'edge',
					css: {
						'curve-style': 'bezier',
						'width': 4,
						'line-color': 'black',
						'target-arrow-shape': 'triangle',
						'target-arrow-color': 'black',
						'arrow-scale': '2'
					}
				},
				{
					selector: 'edge[EDGE_KIND = "TrueEdge"]',
					css: {
						'line-color': 'blue',
						'target-arrow-color': 'blue',
					}
				},
				{
					selector: 'edge[EDGE_KIND = "FalseEdge"]',
					css: {
						'line-color': 'red',
						'target-arrow-color': 'red',
					}
				},			
			],
			
			ready: function () {
				var data = '$$$GRAPH_CONTENT$$$'
				this.graphml({layoutBy: null});
				this.graphml(data);
				
				var expandCollapseOptions = {
					fisheye: false,
					animate: false,
					undoable: false,
					expandCollapseCuePosition: 'bottom-left',
					expandCollapseCueSize: 20,
				};				
				layoutOptions = {
						name: 'fcose',
						  quality: "default",
						  randomize: false, 
						  animate: false, 
						  fit: true, 
						  padding: 30,
						  nodeDimensionsIncludeLabels: true,
						  
						  /* spectral layout options */
						  // False for random, true for greedy sampling
						  samplingType: true,
						  // Sample size to construct distance matrix
						  sampleSize: 25,
						  // Separation amount between nodes
						  nodeSeparation: 100,
						  // Power iteration tolerance
						  piTol: 0.0000001,
						  
						  /* incremental layout options */
						  
						  // Node repulsion (non overlapping) multiplier
						  nodeRepulsion: node => 4500,
						  // Ideal edge (non nested) length
						  idealEdgeLength: edge => 100,
						  // Divisor to compute edge forces
						  edgeElasticity: edge => 0.5,
						  // Nesting factor (multiplier) to compute ideal edge length for nested edges
						  nestingFactor: 0.1,
						  // Maximum number of iterations to perform - this is a suggested value and might be adjusted by the algorithm as required
						  numIter: 2500,
						  // For enabling tiling
						  tile: true,  
						  // Represents the amount of the vertical space to put between the zero degree members during the tiling operation(can also be a function)
						  tilingPaddingVertical: 10,
						  // Represents the amount of the horizontal space to put between the zero degree members during the tiling operation(can also be a function)
						  tilingPaddingHorizontal: 10,
						  // Gravity force (constant)
						  gravity: 0.25,
						  // Gravity range (constant) for compounds
						  gravityRangeCompound: 1.5,
						  // Gravity force (constant) for compounds
						  gravityCompound: 1.0,
						  // Gravity range (constant)
						  gravityRange: 3.8, 
						  // Initial cooling factor for incremental layout  
						  initialEnergyOnIncremental: 0.3,
				};	
				api = this.expandCollapse(expandCollapseOptions);
				api.setOption("layoutBy", layoutOptions);
				
				api.collapseRecursively(this.nodes('[NODE_KIND = "SUBNODE"]'), {
										layoutBy: relayout
									});
			}
		});
		
		function relayout() {
			var layout = cy.layout(layoutOptions);
			if (layout && layout.run) {
				layout.run();
			}
		}
		
		function toggleNodesVisibility(visible, key, selector) {
			targets = cy.nodes('[' + key + ' = "' + selector + '"]');
			console.log((visible ? "showing" : "hiding") + " " + targets.size() + " nodes with '" + key + "' set to '" + selector + "'")
			if (visible)
				targets.style('display', 'element');
			else
				targets.style('display', 'none');
			relayout();
		}
		
		document.getElementById("relayout").addEventListener("click", function () {
			relayout();
		});
		document.getElementById("collapseAll").addEventListener("click", function () {
			api.collapseAll();
		});
		document.getElementById("expandAll").addEventListener("click", function () {
			api.expandAll();
		});
		document.getElementById("collapseSubNodes").addEventListener("click", function () {
			api.collapseRecursively(cy.nodes('[NODE_KIND = "SUBNODE"]'));
		});
		document.getElementById("expandSubNodes").addEventListener("click", function () {
			api.expandRecursively(cy.nodes('[NODE_KIND = "SUBNODE"]'));
		});
		document.getElementById("collapseDescriptions").addEventListener("click", function () {
			api.collapseRecursively(cy.nodes('[NODE_KIND = "DESCRIPTION"]'));
		});
		document.getElementById("expandDescriptions").addEventListener("click", function () {
			api.expandRecursively(cy.nodes('[NODE_KIND = "DESCRIPTION"]'));
		});
		document.getElementById("defaultView").addEventListener("click", function () {
			cy.batch(function() {
				api.expandAll();
				api.expandRecursively(cy.nodes('[NODE_KIND = "DESCRIPTION"]'));
				api.collapseRecursively(cy.nodes('[NODE_KIND = "SUBNODE"]'));
			})
		});
		$$$GRAPH_DISPLAY_LISTENERS$$$
		</script>
	</body>
</html>
